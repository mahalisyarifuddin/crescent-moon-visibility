<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>Hilal Visibility Map</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
		<style>

:root { --primary: #005dac; --on-primary: #ffffff; --hover: #00539a; --background: #f9f9ff; --surface: #ffffff; --text: #181c21; --border: #c1c6d4; --muted: #f2f3fc; --success: #0b6b1d; --on-success: #ffffff; --danger: #ba1a1a; --on-danger: #ffffff; --highlight-bg: #d4e3ff; }
@media (prefers-color-scheme: dark) { :root:not(.light) { --primary: #a5c8ff; --on-primary: #00315f; --hover: #72adff; --background: #101319; --surface: #0b0e14; --text: #e0e2ea; --border: #414752; --muted: #181c21; --success: #82db7e; --on-success: #00390a; --danger: #ffb4ab; --on-danger: #93000a; --highlight-bg: #001c3a; } }
:root.dark { --primary: #a5c8ff; --on-primary: #00315f; --hover: #72adff; --background: #101319; --surface: #0b0e14; --text: #e0e2ea; --border: #414752; --muted: #181c21; --success: #82db7e; --on-success: #00390a; --danger: #ffb4ab; --on-danger: #93000a; --highlight-bg: #001c3a; }
* { box-sizing: border-box; margin: 0; padding: 0; outline-offset: 2px; }
*:focus-visible { outline: 2px solid var(--primary); }
body { background: var(--background); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; min-height: 100vh; padding: 1rem; }
.container { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; max-width: 1200px; padding: 2rem; width: 100%; position: relative; margin: 2rem 0; display: flex; flex-direction: column; }
.hidden { display: none !important; }
h1, h2, h3, label { margin: .5rem 0; }
label { display: block; font-weight: 700; }
input, select, button { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 1rem; padding: .5rem; width: 100%; }
button { cursor: pointer; }
button:disabled { opacity: .6; cursor: not-allowed; }
.primary { background: var(--primary); color: var(--on-primary); border: 0; }
.primary:hover:not(:disabled) { background: var(--hover); }
.secondary:hover:not(:disabled) { background: var(--muted); }
.selectors { position: absolute; right: 2rem; top: 1rem; display: flex; gap: 8px; z-index: 1000; }
.row { display: flex; gap: 1rem; margin-bottom: 1rem; }
.group { flex: 1; }
.info { font-size: .9rem; opacity: .8; line-height: 1.6; }
#map { width: 100%; height: 500px; border: 1px solid var(--border); border-radius: 4px; margin-top: 1rem; }
@media(max-width: 768px) { .selectors { position: static; justify-content: end; margin-bottom: .5rem; } .row { flex-direction: column; } #map { height: 350px; } }

		</style>
	</head>
	<body>
		<div class="container">
            <div class="selectors">
				<select id="language">
					<option value="en">English</option>
					<option value="id">Bahasa Indonesia</option>
				</select>
				<select id="theme">
					<option value="auto">Auto</option>
					<option value="light">Light</option>
					<option value="dark">Dark</option>
				</select>
			</div>

            <h1 id="mapTitle">Hilal Visibility Map</h1>

            <div id="controls">
                <div class="row">
                    <div class="group">
                        <label id="dateLabel" for="mapDate">Date</label>
                        <input type="date" id="mapDate">
                    </div>
                    <div class="group">
                        <label id="regionLabel" for="mapRegion">Region</label>
                        <select id="mapRegion">
                            <option value="indonesia">Indonesia</option>
                            <option value="world">World</option>
                        </select>
                    </div>
                    <div class="group">
                        <label id="criteriaLabel" for="mapCriteria">Criteria</label>
                        <select id="mapCriteria">
                            <option value="mabbims">MABBIMS (Alt≥3°, Elong≥6.4°)</option>
                            <option value="gic">Global Islamic (Alt≥5°, Elong≥8°, <12am UTC)</option>
                            <option value="alt0">Altitude > 0°</option>
                            <option value="custom">Custom Criteria</option>
                        </select>
                    </div>
                </div>

                <div class="row hidden" id="customCriteriaInputs">
                    <div class="group">
                        <label id="minAltLabel" for="minAlt">Min Altitude (°)</label>
                        <input type="number" id="minAlt" value="0" step="0.1">
                    </div>
                    <div class="group">
                        <label id="minElongLabel" for="minElong">Min Elongation (°)</label>
                        <input type="number" id="minElong" value="0" step="0.1">
                    </div>
                </div>

                <div class="row">
                    <button id="renderMap" class="primary">Render Map</button>
                </div>
            </div>

            <div id="mapStatus" class="info" style="font-style:italic; min-height: 1.2em;"></div>
            <div id="map"></div>

            <div id="mapLegend" class="info" style="margin-top:0.5rem">
                <span style="display:inline-block;width:12px;height:12px;background:rgba(0, 255, 0, 0.5);margin-right:4px;border:1px solid green"></span><span id="legendVisible">Visible</span>
            </div>

		</div>

        <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

		<script>
			const text = {
				en: {
					autoTheme: 'Auto Theme',
					lightTheme: 'Light',
					darkTheme: 'Dark',
                    mapTitle: 'Hilal Visibility Map',
                    renderMap: 'Render Map',
                    dateLabel: 'Date',
                    regionLabel: 'Region',
                    criteriaLabel: 'Criteria',
                    legendVisible: 'Visible',
                    minAltLabel: 'Min Altitude (°)',
                    minElongLabel: 'Min Elongation (°)',
                    languageLabel: 'Language',
					themeLabel: 'Theme'
				},
				id: {
					autoTheme: 'Tema Otomatis',
					lightTheme: 'Terang',
					darkTheme: 'Gelap',
                    mapTitle: 'Peta Visibilitas Hilal',
                    renderMap: 'Render Peta',
                    dateLabel: 'Tanggal',
                    regionLabel: 'Wilayah',
                    criteriaLabel: 'Kriteria',
                    legendVisible: 'Terlihat',
                    minAltLabel: 'Min Tinggi (°)',
                    minElongLabel: 'Min Elongasi (°)',
                    languageLabel: 'Bahasa',
					themeLabel: 'Tema'
				}
			};
			const elements = new Proxy({}, { get: (_, id) => document.getElementById(id) });

			class VisibilityMap {
				constructor() {
					this.setup();
					this.theme('auto');
					this.lang(navigator.language?.startsWith('id') ? 'id' : 'en');
				}
				setup() {
					elements.language.onchange = event => this.lang(event.target.value);
					elements.theme.onchange = event => this.theme(event.target.value);
                    elements.renderMap.onclick = () => this.handleRenderClick();
                    elements.mapCriteria.onchange = () => this.toggleCustom();
                    elements.mapRegion.onchange = () => this.handleRegionChange();

                    elements.mapDate.valueAsDate = new Date();

                    this.map = L.map('map').setView([-2.5, 118], 5);
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(this.map);

                    this.overlayLayer = null;
                    this.isRendering = false;
                    this.worker = new Worker('worker.js');
                    this.worker.onmessage = (e) => this.handleWorkerMessage(e);
				}
				string(key) {
					return text[this.language]?.[key] ?? key;
				}
				theme(themeName) {
					document.documentElement.className = themeName === 'auto' ? '' : themeName;
					elements.theme.value = themeName;
				}
				lang(language) {
					this.language = elements.language.value = document.documentElement.lang = language;
					Object.keys(text.en).forEach(key => elements[key] && (elements[key].textContent = this.string(key)));
					[...elements.theme.options].forEach(option => option.textContent = this.string(option.value + 'Theme'));
				}
                toggleCustom() {
                    const isCustom = elements.mapCriteria.value === 'custom';
                    elements.customCriteriaInputs.classList.toggle('hidden', !isCustom);
                }

                handleRegionChange() {
                    const region = elements.mapRegion.value;
                    if (region === 'indonesia') {
                        this.map.setView([-2.5, 118], 5);
                    } else {
                        this.map.setView([0, 0], 2);
                    }
                }

                handleRenderClick() {
                    if (this.isRendering) {
                        this.worker.terminate();
                        this.worker = new Worker('worker.js');
                        this.worker.onmessage = (e) => this.handleWorkerMessage(e);

                        this.isRendering = false;
                        elements.renderMap.disabled = false;
                        elements.mapStatus.textContent = 'Cancelled.';
                    } else {
                        this.startRender();
                    }
                }

                startRender() {
                    this.isRendering = true;
                    elements.renderMap.disabled = false; // Allow cancelling
                    elements.renderMap.textContent = 'Cancel';
                    elements.mapStatus.textContent = 'Calculating...';

                    const mapBounds = this.map.getBounds();
                    const bounds = {
                        minLat: Math.max(-85, mapBounds.getSouth()),
                        maxLat: Math.min(85, mapBounds.getNorth()),
                        minLon: mapBounds.getWest(),
                        maxLon: mapBounds.getEast()
                    };

                    const criteria = elements.mapCriteria.value;
                    const dateStr = elements.mapDate.value;
                    const dateObj = new Date(dateStr ? dateStr + 'T12:00:00Z' : new Date());

                    const mapSize = this.map.getSize();
                    const widthDeg = bounds.maxLon - bounds.minLon;
                    const heightDeg = bounds.maxLat - bounds.minLat;

                    this.lastBounds = bounds;

                    this.worker.postMessage({
                        bounds: bounds,
                        widthDeg: widthDeg,
                        heightDeg: heightDeg,
                        mapSizeX: mapSize.x,
                        criteria: criteria,
                        dateTimestamp: dateObj.getTime(),
                        minAlt: parseFloat(elements.minAlt.value) || 0,
                        minElong: parseFloat(elements.minElong.value) || 0
                    });
                }

                handleWorkerMessage(e) {
                    const { status, percent, imageData: unused, buffer, width, height, message } = e.data;

                    if (status === 'progress') {
                        elements.mapStatus.textContent = `Calculating... ${percent}%`;
                    } else if (status === 'complete') {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        const imageData = new ImageData(buffer, width, height);
                        ctx.putImageData(imageData, 0, 0);

                        this.updateOverlay(canvas.toDataURL(), this.lastBounds);

                        this.isRendering = false;
                        elements.renderMap.disabled = false;
                        elements.renderMap.textContent = this.string('renderMap');
                        elements.mapStatus.textContent = 'Done.';
                    } else if (status === 'error') {
                        console.error('Worker Error:', message);
                        elements.mapStatus.textContent = 'Error: ' + message;
                        this.isRendering = false;
                        elements.renderMap.disabled = false;
                        elements.renderMap.textContent = this.string('renderMap');
                    }
                }

                updateOverlay(imageUrl, bounds) {
                    if (this.overlayLayer) {
                        this.map.removeLayer(this.overlayLayer);
                    }
                    const imageBounds = [[bounds.minLat, bounds.minLon], [bounds.maxLat, bounds.maxLon]];
                    this.overlayLayer = L.imageOverlay(imageUrl, imageBounds).addTo(this.map);
                }
			}
			new VisibilityMap();
		</script>
	</body>
</html>
